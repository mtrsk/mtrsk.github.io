<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
  Experiments With Erlang And Nix

    </title>
    <meta property="og:url" content="https://mtrsk.github.io/blog/2024/experiments-with-erlang-and-nix/">
  <meta property="og:site_name" content="Benevides&#39; Blog">
  <meta property="og:title" content="Experiments With Erlang And Nix">
  <meta property="og:description" content="Recently I’ve been collaborating with friends on Lyceum, an MMO game with an Erlang backend and a Zig &#43; Raylib client (as if erlang wasn’t a weird enough of a choice). Now, this is an unusual combination, but that’s the whole reason our pesky group exists in the first place (if you want to know more check my friend’s Lemos post).
There is also a couple of standards we try to follow when doing this project, all of the team works with microservices all day in their normal jobs, so whenever we want to do something we try follow some simple rules:">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2024-09-07T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-09-07T00:00:00+00:00">
<link rel="stylesheet" href="/css/main.min.1135c79bd24c232c465ba2c4e5a9644086ce3f8358dbd0e0d76c5e86d24f1fad.css" />
    
        <script type="text/javascript" src ="https://d3js.org/d3.v7.min.js"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  
      inlineMath: [['\\(', '\\)']]                  
    }
  };
</script>

    
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
  </head>
  <body><nav>
  <img
    src="/img/logo.png"
    alt="put your logo here"
    width="128"
    height="128"
  />
  <div>
    <h1>Benevides&#39; Blog</h1><p>&#34;Writing is nothing more than a guided dream.&#34;</p>
  </div>
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/blog">Blog</a></li>
    <li><a href="/notes">Notes</a></li>
    <li><a href="/blogroll">BlogRoll</a></li>
  </ul>
</nav>
<main>
  <h2>Experiments With Erlang And Nix
    <small>
      <time>September 7, 2024</time>
    by Marcos Benevides


    </small>
  </h2><p>Recently I&rsquo;ve been collaborating with friends on <a href="https://github.com/Dr-Nekoma/lyceum">Lyceum</a>, an MMO game with an
<a href="https://www.erlang.org/">Erlang</a> backend and a <a href="https://ziglang.org/">Zig</a> + <a href="https://www.raylib.com/">Raylib</a> client (as if erlang wasn&rsquo;t a weird enough of
a choice). Now, this is an unusual combination, but that&rsquo;s the whole reason <a href="https://github.com/Dr-Nekoma">our
pesky group</a> exists in the first place (if you want to know more check <a href="https://duing.dev/posts/beyondhackers/">my
friend&rsquo;s Lemos post</a>).</p>
<p>There is also a couple of standards we try to follow when doing this project, all
of the team works with microservices all day in their normal jobs, so whenever
we want to do something we try follow some simple rules:</p>
<ol>
<li>Can we develop all of the project parts locally? Preferably with no
networking as well (besides pulling dependencies).</li>
<li>Can we do so by leveraging a couple handy tools to their limit?</li>
</ol>
<p>One can imagine that setting up such a development environment might be
nightmarish, but thankfully the 21st century brought us some interesting tools
that make Unix less of a mess to deal with, and yes, I&rsquo;m talking about <a href="https://nixos.org/">Nix</a>. My
goal here is to show people what our development experience looks like and maybe
convince a few souls dealing with more normal tools (<code>brew</code>, <code>asdf</code>, <code>&lt;insert random linux package manager&gt;</code>, &hellip;) to at least give Nix a try.</p>
<h2 id="devenv">Devenv</h2>
<p>We use <a href="https://devenv.sh/">devenv</a> to setup our development shell, think of it as your favorite
programming language&rsquo;s envinroment and dependency manager (<code>pip</code>, <code>poetry</code>, <code>nvm</code>,
<code>rvm</code>, &hellip;) but capable of installing anything availiable on <a href="https://search.nixos.org/packages">nixpkgs</a> and
much more.</p>
<h3 id="a-unified-development-shell-for-erlang-and-zig">A unified development shell for Erlang and Zig</h3>
<p>No one is expected to have <code>Erlang</code>, <code>Zig</code> and <code>Postgres</code> installed, nor are they
expected to have any of the environment variables needed for this project to
work, the development shell already does all of that boring stuff for
you. Here&rsquo;s a snippet of what it looks like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl">  <span class="c1"># (...)</span>
</span></span><span class="line"><span class="cl">  <span class="n">devShells</span> <span class="err">=</span> <span class="n">forAllSystems</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">system</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span>
</span></span><span class="line"><span class="cl">      <span class="n">pkgs</span> <span class="o">=</span> <span class="n">nixpkgs</span><span class="o">.</span><span class="n">legacyPackages</span><span class="o">.</span><span class="si">${</span><span class="n">system</span><span class="si">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1"># Erlang shit</span>
</span></span><span class="line"><span class="cl">      <span class="n">erlangLatest</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">erlang_27</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">erlangLibs</span> <span class="o">=</span> <span class="n">getErlangLibs</span> <span class="n">erlangLatest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1"># Zig shit</span>
</span></span><span class="line"><span class="cl">      <span class="n">raylib</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">raylib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">zigLatest</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">zig</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">linuxPkgs</span> <span class="o">=</span> <span class="k">with</span> <span class="n">pkgs</span><span class="p">;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">inotify-tools</span>
</span></span><span class="line"><span class="cl">        <span class="n">xorg</span><span class="o">.</span><span class="n">libX11</span>
</span></span><span class="line"><span class="cl">        <span class="n">xorg</span><span class="o">.</span><span class="n">libXrandr</span>
</span></span><span class="line"><span class="cl">        <span class="n">xorg</span><span class="o">.</span><span class="n">libXinerama</span>
</span></span><span class="line"><span class="cl">        <span class="n">xorg</span><span class="o">.</span><span class="n">libXcursor</span>
</span></span><span class="line"><span class="cl">        <span class="n">xorg</span><span class="o">.</span><span class="n">libXi</span>
</span></span><span class="line"><span class="cl">        <span class="n">xorg</span><span class="o">.</span><span class="n">libXi</span>
</span></span><span class="line"><span class="cl">        <span class="n">libGL</span>
</span></span><span class="line"><span class="cl">      <span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">darwinPkgs</span> <span class="o">=</span> <span class="k">with</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">darwin</span><span class="o">.</span><span class="n">apple_sdk</span><span class="o">.</span><span class="n">frameworks</span><span class="p">;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">CoreFoundation</span>
</span></span><span class="line"><span class="cl">        <span class="n">CoreServices</span>
</span></span><span class="line"><span class="cl">      <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="k">in</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># (...) This will be shown in the next section</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="c1"># `nix develop`</span>
</span></span><span class="line"><span class="cl">      <span class="n">default</span> <span class="o">=</span> <span class="n">devenv</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">mkShell</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">inherit</span> <span class="n">inputs</span> <span class="n">pkgs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span> <span class="n">pkgs</span><span class="o">,</span> <span class="n">lib</span><span class="o">,</span> <span class="o">...</span> <span class="p">}:</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="n">packages</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">                <span class="k">with</span> <span class="n">pkgs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">[</span>
</span></span><span class="line"><span class="cl">                  <span class="n">erlang-ls</span>
</span></span><span class="line"><span class="cl">                  <span class="n">erlfmt</span>
</span></span><span class="line"><span class="cl">                  <span class="n">just</span>
</span></span><span class="line"><span class="cl">                  <span class="n">rebar3</span>
</span></span><span class="line"><span class="cl">                  <span class="n">dbeaver-bin</span>
</span></span><span class="line"><span class="cl">                <span class="p">]</span>
</span></span><span class="line"><span class="cl">                <span class="o">++</span> <span class="n">lib</span><span class="o">.</span><span class="n">optionals</span> <span class="n">stdenv</span><span class="o">.</span><span class="n">isLinux</span> <span class="p">(</span><span class="n">linuxPkgs</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="o">++</span> <span class="n">lib</span><span class="o">.</span><span class="n">optionals</span> <span class="n">stdenv</span><span class="o">.</span><span class="n">isDarwin</span> <span class="n">darwinPkgs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="n">languages</span><span class="o">.</span><span class="n">erlang</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">package</span> <span class="o">=</span> <span class="n">erlangLatest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="n">languages</span><span class="o">.</span><span class="n">zig</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">package</span> <span class="o">=</span> <span class="n">zigLatest</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="n">env</span> <span class="o">=</span> <span class="n">mkEnvVars</span> <span class="n">pkgs</span> <span class="n">erlangLatest</span> <span class="n">erlangLibs</span> <span class="n">raylib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="n">scripts</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">build</span><span class="o">.</span><span class="n">exec</span> <span class="o">=</span> <span class="s2">&#34;just build&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">server</span><span class="o">.</span><span class="n">exec</span> <span class="o">=</span> <span class="s2">&#34;just server&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="n">enterShell</span> <span class="o">=</span> <span class="s1">&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">                echo &#34;Starting Development Environment...&#34;
</span></span></span><span class="line"><span class="cl"><span class="s1">                just deps
</span></span></span><span class="line"><span class="cl"><span class="s1">              &#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">              <span class="n">services</span><span class="o">.</span><span class="n">postgres</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">package</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">postgresql_16</span><span class="o">.</span><span class="n">withPackages</span> <span class="p">(</span><span class="n">p</span><span class="p">:</span> <span class="k">with</span> <span class="n">p</span><span class="p">;</span> <span class="p">[</span> <span class="n">p</span><span class="o">.</span><span class="n">periods</span> <span class="p">]);</span>
</span></span><span class="line"><span class="cl">                <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">initialDatabases</span> <span class="o">=</span> <span class="p">[</span> <span class="p">{</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;mmo&#34;</span><span class="p">;</span> <span class="p">}</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">                <span class="n">port</span> <span class="o">=</span> <span class="mi">5432</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">listen_addresses</span> <span class="o">=</span> <span class="s2">&#34;127.0.0.1&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="n">initialScript</span> <span class="o">=</span> <span class="s1">&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">                  CREATE USER admin SUPERUSER;
</span></span></span><span class="line"><span class="cl"><span class="s1">                  ALTER USER admin PASSWORD &#39;admin&#39;;
</span></span></span><span class="line"><span class="cl"><span class="s1">                  GRANT ALL PRIVILEGES ON DATABASE mmo to admin;
</span></span></span><span class="line"><span class="cl"><span class="s1">                &#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="p">};</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">     <span class="c1"># (...)</span>
</span></span></code></pre></div><p>Let&rsquo;s try building the <code>Zig</code> client:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  $ just client-build
</span></span><span class="line"><span class="cl">  $ just client
</span></span></code></pre></div><p><a id="figure--fig:lyceum-client"></a></p>
<figure><img src="/img/some_experiments_with_nix_and_erlang/00_lyceum_client.png"
    alt="Figure 1: It just works"><figcaption>
      <p><span class="figure-number">Figure 1: </span>It just works</p>
    </figcaption>
</figure>

<h4 id="running-postgres">Running Postgres</h4>
<p>As you may have noticed, not only are we installing <code>Erlang</code> and <code>Zig</code>, some
madlad even put <code>dbeaver</code> there for God knows what reason, but hey, that&rsquo;s the dev
shell, just do whatever you want. We also have a local postgres setup and the
workflow mimics what you usually have with <code>docker-compose</code> or <code>podman</code>. By running:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  devenv up
</span></span></code></pre></div><p>inside the shell, a local <code>Postgres 16</code> with custom extensions will be
spinned. The list of services supported by <code>devenv</code> keeps growing and you can
check them <a href="https://devenv.sh/services/#supported-services">here</a>.</p>
<p><a id="figure--fig:lyceum-client"></a></p>
<figure><img src="/img/some_experiments_with_nix_and_erlang/01_postgres.png"
    alt="Figure 2: It just works (x2)"><figcaption>
      <p><span class="figure-number">Figure 2: </span>It just works (x2)</p>
    </figcaption>
</figure>

<h4 id="direnv">Direnv</h4>
<p>As if thigs weren&rsquo;t awesome enough, I need to talk about <a href="https://direnv.net/">direnv</a>, a simple tool
that can make wonders (and it comes with nix integrations for free), with a
single <code>.envrc</code> in your project&rsquo;s repo you can jump inside a certain development
shell just by <code>cd</code>-ing into the directory. Here&rsquo;s an example of my
<code>.envrc</code>:</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">use flake . --impure
</code></pre><p>followed by a <code>direnv allow</code> in my shell:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  $ direnv allow
</span></span><span class="line"><span class="cl">  direnv: loading ~/Code/Personal/lyceum/.envrc
</span></span><span class="line"><span class="cl">  direnv: using flake . --impure
</span></span><span class="line"><span class="cl">  direnv: nix-direnv: Renewed cache
</span></span><span class="line"><span class="cl">  Starting Development Environment...
</span></span><span class="line"><span class="cl">  rebar3 get-deps
</span></span><span class="line"><span class="cl">  <span class="o">===</span>&gt; Verifying dependencies...
</span></span><span class="line"><span class="cl">  rebar3 nix <span class="nv">lock</span>
</span></span><span class="line"><span class="cl">  <span class="o">===</span>&gt; Verifying dependencies...
</span></span><span class="line"><span class="cl">  <span class="c1"># (...)</span>
</span></span></code></pre></div><p>That&rsquo;s it. Now every time I <code>cd &lt;lyceum-directory&gt;</code>, I&rsquo;ll immediatly load the
whole development shell and be ready to work on it. This section is optional but
it really simplifies my life, as I don&rsquo;t need to remember to activate/deactivate
an environment.</p>
<h3 id="the-ci-environment">The CI environment</h3>
<p>Since we are already went to the trouble of setting up a whole dev environment
for Erlang and Zig, we should just make another one for when we need to run
builds and test suites on CI.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl">    <span class="c1"># `nix develop .#ci`</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># reduce the number of packages to the bare minimum needed for CI</span>
</span></span><span class="line"><span class="cl">    <span class="n">ci</span> <span class="err">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">mkShell</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">env</span> <span class="o">=</span> <span class="n">mkEnvVars</span> <span class="n">pkgs</span> <span class="n">erlangLatest</span> <span class="n">erlangLibs</span> <span class="n">raylib</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">buildInputs</span> <span class="o">=</span> <span class="k">with</span> <span class="n">pkgs</span><span class="p">;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">erlangLatest</span>
</span></span><span class="line"><span class="cl">        <span class="n">heroku</span>
</span></span><span class="line"><span class="cl">        <span class="n">just</span>
</span></span><span class="line"><span class="cl">        <span class="n">rebar3</span>
</span></span><span class="line"><span class="cl">        <span class="n">zigLatest</span>
</span></span><span class="line"><span class="cl">      <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span></code></pre></div><p>If you use Github Actions, now you can leverage both the <a href="https://github.com/cachix/install-nix-action">Install Nix</a> and <a href="https://github.com/DeterminateSystems/magic-nix-cache">Magic
Nix Cache</a> actions.</p>
<h3 id="the-full-devshell">The full devshell</h3>
<p>You can check what the full devshell looks like <a href="https://github.com/Dr-Nekoma/lyceum/blob/master/flake.nix">here</a>.</p>
<h2 id="nix-build">Nix Build</h2>
<p>In the previous section I&rsquo;ve showed you our impure environment, there&rsquo;s no way
(as of now) to make things 100% pure while developing, specially because we need
to have a postgres service running to debug and test locally. However, things
change when we talk about releases, we need to find a way to properly build the
server.</p>
<h3 id="a-pure-build-of-the-erlang-server">A pure build of the Erlang server</h3>
<p>This is the original reason I&rsquo;ve decided to write this, it took me some time to
go through the <a href="https://nixos.org/manual/nixpkgs/stable/#sec-beam">NixOS BEAM manual</a> and I&rsquo;ve yet to know how to properly build this
project with the <a href="https://nixos.org/manual/nixpkgs/stable/#build-tools-rebar3">buildRebar3 Tools</a> (it seems it&rsquo;s used more inside Nixpkgs
itself than to integrate with Erlang projects). Nevertheless, you can properly
package this with the abstractions plain Nix already gives you:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl">  <span class="c1"># Leverages nix to build the erlang backend release</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># nix build .#server</span>
</span></span><span class="line"><span class="cl">  <span class="n">server</span> <span class="err">=</span>
</span></span><span class="line"><span class="cl">    <span class="k">let</span>
</span></span><span class="line"><span class="cl">      <span class="n">deps</span> <span class="o">=</span> <span class="kn">import</span> <span class="sr">./rebar-deps.nix</span> <span class="p">{</span> <span class="k">inherit</span> <span class="p">(</span><span class="n">pkgs</span><span class="p">)</span> <span class="n">fetchHex</span> <span class="n">fetchFromGitHub</span> <span class="n">fetchgit</span><span class="p">;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="k">in</span>
</span></span><span class="line"><span class="cl">    <span class="n">pkgs</span><span class="o">.</span><span class="n">stdenv</span><span class="o">.</span><span class="n">mkDerivation</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;server&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">version</span> <span class="o">=</span> <span class="s2">&#34;0.0.1&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">src</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">cleanSource</span> <span class="sr">./.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">buildInputs</span> <span class="o">=</span> <span class="k">with</span> <span class="n">pkgs</span><span class="p">;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">erlangLatest</span>
</span></span><span class="line"><span class="cl">        <span class="n">pkgs</span><span class="o">.</span><span class="n">stdenv</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">cc</span><span class="o">.</span><span class="n">lib</span>
</span></span><span class="line"><span class="cl">        <span class="n">rebar3</span>
</span></span><span class="line"><span class="cl">        <span class="n">just</span>
</span></span><span class="line"><span class="cl">        <span class="n">gnutar</span>
</span></span><span class="line"><span class="cl">      <span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">nativeBuildInputs</span> <span class="o">=</span> <span class="k">with</span> <span class="n">pkgs</span><span class="p">;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">autoPatchelfHook</span>
</span></span><span class="line"><span class="cl">        <span class="n">coreutils</span>
</span></span><span class="line"><span class="cl">        <span class="n">gawk</span>
</span></span><span class="line"><span class="cl">        <span class="n">gnugrep</span>
</span></span><span class="line"><span class="cl">        <span class="n">libz</span>
</span></span><span class="line"><span class="cl">        <span class="n">ncurses</span>
</span></span><span class="line"><span class="cl">        <span class="n">openssl</span>
</span></span><span class="line"><span class="cl">        <span class="n">systemdLibs</span>
</span></span><span class="line"><span class="cl">      <span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">buildPhase</span> <span class="o">=</span> <span class="s1">&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        mkdir -p _checkouts
</span></span></span><span class="line"><span class="cl"><span class="s1">        # https://github.com/NixOS/nix/issues/670#issuecomment-1211700127
</span></span></span><span class="line"><span class="cl"><span class="s1">        export HOME=$(pwd)
</span></span></span><span class="line"><span class="cl"><span class="s1">        </span><span class="si">${</span><span class="nb">toString</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">pkgs</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">mapAttrsToList</span> <span class="p">(</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="p">:</span> <span class="s1">&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">            cp -R --no-preserve=mode </span><span class="si">${</span><span class="n">v</span><span class="si">}</span><span class="s1"> _checkouts/</span><span class="si">${</span><span class="n">k</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">          &#39;&#39;</span><span class="p">)</span> <span class="n">deps</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span><span class="si">}</span><span class="s1">
</span></span></span><span class="line"><span class="cl"><span class="s1">        just release-nix
</span></span></span><span class="line"><span class="cl"><span class="s1">      &#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">installPhase</span> <span class="o">=</span> <span class="s1">&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s1">        mkdir -p $out
</span></span></span><span class="line"><span class="cl"><span class="s1">        mkdir -p $out/database
</span></span></span><span class="line"><span class="cl"><span class="s1">        # Add migrations to the output as well, otherwise the server
</span></span></span><span class="line"><span class="cl"><span class="s1">        # breaks at runtime.
</span></span></span><span class="line"><span class="cl"><span class="s1">        cp -r database/migrations $out/database
</span></span></span><span class="line"><span class="cl"><span class="s1">        tar -xzf _build/prod/rel/*/*.tar.gz -C $out/
</span></span></span><span class="line"><span class="cl"><span class="s1">      &#39;&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span></code></pre></div><p>This is a derivation, a meta-package, a recipe containing every step and every
dependecy I need to satisfy and properly build our server. Now, as for the
<code>deps.nix</code> file, it was auto-generated with <a href="https://github.com/erlang-nix/rebar3_nix">rebar3-nix</a>, which itself has a <code>rebar3</code>
plugin. So everytime someone adds a BEAM dependency in our current flow, we
automatically generate a nix lockfile to match the rebar3 lockfile as
well. Here&rsquo;s what we needed to add in our <code>rebar3</code> config to benefit from the Nix
integration:</p>
<pre tabindex="0"><code class="language-nil" data-lang="nil">{plugins, [
    { rebar3_nix, &#34;.*&#34;, {git, &#34;https://github.com/erlang-nix/rebar3_nix.git&#34;, {tag, &#34;v0.1.1&#34;}}}
]}.
</code></pre><p>now let&rsquo;s see if this really works:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  $ nix build .#server
</span></span><span class="line"><span class="cl">  <span class="c1"># (...)</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># We now have a `result` directory in the project&#39;s root...</span>
</span></span><span class="line"><span class="cl">  $ ls ./result/
</span></span><span class="line"><span class="cl">  bin  database  erts-13.2.2.10  lib  releases
</span></span><span class="line"><span class="cl">  <span class="c1"># Now try running the server we&#39;ve just build and...</span>
</span></span><span class="line"><span class="cl">  $ ./result/bin/server foreground
</span></span><span class="line"><span class="cl">  Exec: /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server/erts-13.2.2.10/bin/erlexec -noinput +Bd -boot /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server/releases/0.0.1/start -mode embedded -boot_var SYSTEM_LIB_DIR /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server/lib -config /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server/releases/0.0.1/sys.config -args_file /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server/releases/0.0.1/vm.args -- foreground
</span></span><span class="line"><span class="cl">  Root: /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server
</span></span><span class="line"><span class="cl">  /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server
</span></span><span class="line"><span class="cl">  Connecting to: <span class="s2">&#34;127.0.0.1&#34;</span>
</span></span><span class="line"><span class="cl">  Connected to <span class="s2">&#34;127.0.0.1&#34;</span> with <span class="nv">USER</span> <span class="o">=</span> <span class="s2">&#34;admin&#34;</span>
</span></span><span class="line"><span class="cl">  Finding migration scripts...
</span></span><span class="line"><span class="cl">  Migration Path: <span class="s2">&#34;/nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server/database/migrations&#34;</span>
</span></span><span class="line"><span class="cl">  Running DB migrations.
</span></span><span class="line"><span class="cl">  Migrations completed successfully.
</span></span><span class="line"><span class="cl">  <span class="c1"># (...) it works</span>
</span></span></code></pre></div><h2 id="containers">Containers</h2>
<p>There is a treasure trove of examples in <a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/build-support/docker/examples.nix#L218">Nixpkgs</a>, I&rsquo;ve decided to go with the
<strong><strong>simplest</strong></strong> one. This what a container for the backend looks like in Nix:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl">  <span class="c1"># nix build .#dockerImage</span>
</span></span><span class="line"><span class="cl">  <span class="n">dockerImage</span> <span class="err">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">dockerTools</span><span class="o">.</span><span class="n">buildLayeredImage</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span> <span class="o">=</span> <span class="s2">&#34;lyceum&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tag</span> <span class="o">=</span> <span class="s2">&#34;latest&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">created</span> <span class="o">=</span> <span class="s2">&#34;now&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># This will copy the erlang release derivation from the</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># previous step into to the image</span>
</span></span><span class="line"><span class="cl">    <span class="n">contents</span> <span class="o">=</span> <span class="p">[</span> <span class="n">server</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">coreutils</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">gawk</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">gnugrep</span> <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">Cmd</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;</span><span class="si">${</span><span class="n">server</span><span class="si">}</span><span class="s2">/bin/server&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;foreground&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">Env</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;ERL_DIST_PORT=8001&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="p">];</span>
</span></span><span class="line"><span class="cl">      <span class="n">ExposedPorts</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;8080/tcp&#34;</span> <span class="o">=</span> <span class="p">{</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">      <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span></code></pre></div><p>It doesn&rsquo;t really look like most Dockerfiles you see around the net. Notice that
I&rsquo;m using the <code>server</code> derivation from the previous step, the hard work required
to make it work the first time is immediatly rewarded because now we can keep
composing the previous solutions into more complex flows. To test this, let&rsquo;s
build the image:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  $ nix build .#dockerImage
</span></span><span class="line"><span class="cl">  <span class="c1"># Now load the build image in docker (or podman)</span>
</span></span><span class="line"><span class="cl">  $ docker load &lt; ./result
</span></span><span class="line"><span class="cl">  <span class="c1"># Make sure you have `devenv up` running</span>
</span></span><span class="line"><span class="cl">  $ docker container run --network<span class="o">=</span>host --rm lyceum:latest
</span></span><span class="line"><span class="cl">  Exec: /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server/erts-13.2.2.10/bin/erlexec -noinput +Bd -boot /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server/releases/0.0.1/start -mode embedded -boot_var SYSTEM_LIB_DIR /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server/lib -config /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server/releases/0.0.1/sys.config -args_file /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server/releases/0.0.1/vm.args -- foreground
</span></span><span class="line"><span class="cl">  Root: /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server
</span></span><span class="line"><span class="cl">  /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server
</span></span><span class="line"><span class="cl">  server<span class="o">[</span>1<span class="o">]</span> Starting up
</span></span><span class="line"><span class="cl">  Connecting to: <span class="s2">&#34;127.0.0.1&#34;</span>
</span></span><span class="line"><span class="cl">  Connected to <span class="s2">&#34;127.0.0.1&#34;</span> with <span class="nv">USER</span> <span class="o">=</span> <span class="s2">&#34;admin&#34;</span>
</span></span><span class="line"><span class="cl">  Finding migration scripts...
</span></span><span class="line"><span class="cl">  Migration Path: <span class="s2">&#34;/nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server/database/migrations&#34;</span>
</span></span><span class="line"><span class="cl">  Running DB migrations.
</span></span><span class="line"><span class="cl">  Migrations completed successfully.
</span></span><span class="line"><span class="cl">  <span class="c1"># (...)</span>
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>As I wanted to show here, we&rsquo;ve used Nix all the way from defining a common
development environment for the developers, reused some of the stuff in CI, to
later repurpose some of the flows for pure builds, that later got shoved into
our containers, all by leveraging the <strong><strong>same tool</strong></strong>. I wish modern devops was more
about that, but it seems it&rsquo;ll take time for people to realize that
<strong><strong>immutability</strong></strong>, <strong><strong>composition</strong></strong> and <strong><strong>functional programming</strong></strong> can go hand in hand
and give us a better experience than one can find in most other solutions (built
by trillion dollar companies who want you to manage infra with YAML). Luckilly,
Nix is <a href="https://www.youtube.com/watch?v=FJVFXsNzYZQ">gaining some traction</a> and more people are talking about it.</p>
<p>I&rsquo;ve been using it for the past 6 years in my workstations and don&rsquo;t regret
doing so, its a tool worth learning (and there&rsquo;s still so much to learn about
it), it makes my life dealing with Unix systems less painfull.</p>
<h3 id="todo">TODO</h3>
<p>There is still much to do, and it can be left for a part II later.</p>
<ul>
<li><input disabled="" type="checkbox"> I have yet to learn how to deploy a production-ready erlang system. Add
(<a href="#citeproc_bib_item_1">Cesarini and Vinoski 2016</a>) to my readlist.</li>
<li><input disabled="" type="checkbox"> Properly build the client, it seems that <a href="https://github.com/nix-community/zon2nix">non2nix</a> breaks with the <a href="https://github.com/nix-community/zon2nix/issues/6">format for
zon files</a>, I&rsquo;m not familiar with Zig toolig and ill take a look at this later</li>
<li><input disabled="" type="checkbox"> We are still unsure where to deploy, but I really want to move away from
Heroku and check what Nix has to offer to manage a fleet of VMs.</li>
</ul>
<h2 id="references">References</h2>
<style>.csl-entry{text-indent: -1.5em; margin-left: 1.5em;}</style><div class="csl-bib-body">
  <div class="csl-entry"><a id="citeproc_bib_item_1"></a>Cesarini, Francesco, and Steve Vinoski. 2016. <i>Designing for Scalability with Erlang/Otp: Implement Robust, Fault-Tolerant Systems</i>. O’Reilly Media, Inc.</div>
</div>



   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   




  <hr>
  <div class="bl-section">
    <h4>Links to this note</h4>
    <div class="backlinks">
      <ul>
       
          <li><a href="/blog/2024/you-have-10-seconds-to-nixify-your-dotnet-project/">You Have 10 Seconds To Nixify Your Dotnet Project</a></li>
       
     </ul>
    </div>
  </div>


<footer>
  </br>
  <p>
  Built with <a href="https://orgmode.org/">Orgmode</a>, <a href="https://www.gnu.org/software/emacs/">Emacs</a> and <a href="https://nixos.org/">Nix</a>, source code availiable <a href="https://github.com/mtrsk/mtrsk.github.io">here</a>.
  </p>
</footer>

      </main>
    </main>
  </body>
</html>
