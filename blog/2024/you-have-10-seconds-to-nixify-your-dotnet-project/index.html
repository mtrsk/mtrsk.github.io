<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
  You Have 10 Seconds To Nixify Your Dotnet Project

    </title>
    <meta property="og:url" content="https://mtrsk.github.io/blog/2024/you-have-10-seconds-to-nixify-your-dotnet-project/">
  <meta property="og:site_name" content="Benevides&#39; Blog">
  <meta property="og:title" content="You Have 10 Seconds To Nixify Your Dotnet Project">
  <meta property="og:description" content="Figure 1: Don “The Gun” Syme, now officially part of the “Nix Gang”.
While this is a click bait title (maybe I’ve also farmed some zoomer credits out the OC), I’m pretty sure that’s how Don Syme feels when looks at a Result type like Result&lt;&#39;T,string&gt; in an F# codebase. The reason why I’ve written this post is that I started doing changes in a open source project I develop/maintain, and realized other .">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="blog">
    <meta property="article:published_time" content="2024-09-16T00:00:00+00:00">
    <meta property="article:modified_time" content="2024-09-16T00:00:00+00:00">
<link rel="stylesheet" href="/css/main.min.1135c79bd24c232c465ba2c4e5a9644086ce3f8358dbd0e0d76c5e86d24f1fad.css" />
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  </head>
  <body><nav>
  <img
    src="/img/logo.png"
    alt="put your logo here"
    width="128"
    height="128"
  />
  <div>
    <h1>Benevides&#39; Blog</h1><p>&#34;Writing is nothing more than a guided dream.&#34;</p>
  </div>
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/blog">Blog</a></li>
    <li><a href="/notes">Notes</a></li>
    <li><a href="/blogroll">BlogRoll</a></li>
  </ul>
</nav>
<main>
  <h2>You Have 10 Seconds To Nixify Your Dotnet Project
    <small>
      <time>September 16, 2024</time>
    by Marcos Benevides


    </small>
  </h2><p><a id="figure--fig:gun-syme"></a></p>
<figure><img src="/img/you_have_10_seconds_to_nixify_your_dotnet_project/00_don_gun.png"
    alt="Figure 1: Don &amp;ldquo;The Gun&amp;rdquo; Syme, now officially part of the &amp;ldquo;Nix Gang&amp;rdquo;."><figcaption>
      <p><span class="figure-number">Figure 1: </span>Don &ldquo;The Gun&rdquo; Syme, now officially part of the &ldquo;Nix Gang&rdquo;.</p>
    </figcaption>
</figure>

<p>While this is a click bait title (maybe I&rsquo;ve also farmed some zoomer credits out
the OC), I&rsquo;m pretty sure that&rsquo;s how Don Syme feels when looks at a <a href="https://learn.microsoft.com/en-us/dotnet/fsharp/language-reference/results">Result</a> type
like <code>Result&lt;'T,string&gt;</code> in an F# codebase. The reason why I&rsquo;ve written this post
is that I started doing changes in a <a href="https://github.com/mtrsk/interval.fs">open source project</a> I develop/maintain,
and realized other .Net people could benefit from this somehow (as most of the
Nix + .Net guides are from before 2024).</p>
<h2 id="an-opinionated-template">An Opinionated Template</h2>
<p>Turns out that, while writing this, I&rsquo;ve decided to put everything in a template
that&rsquo;s easy to <del>steal</del> copy, so if you are from the future and have the <a href="https://nixos.org/download/">Nix (the
package manager)</a> and the <a href="https://nixos.wiki/wiki/Flakes">Flakes</a> feature enabled you&rsquo;ll be able to reproduce this
post. Additionally, someone beat me into writing a flake for F#, here&rsquo;s <a href="https://github.com/NixOS/templates/tree/master/dotnet">a more
official take</a> on it, there are a couple changes from my repo and this one,
mostly because I tend to favor devenv (since it has shown better adoption when I
preached it to non-Nixers).</p>
<h3 id="devenv">Devenv</h3>
<p>I&rsquo;ve already tackled this in a <a href="https://mtrsk.github.io/blog/2024/experiments-with-erlang-and-nix/">previous article</a>, but the best developer
experience right now is with <a href="https://devenv.sh/">devenv.sh</a>. Unlike the previous article tho, the
environment setup is way simpler, just a bunch of .Net tools inside the shell
and call it a day.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl">  <span class="c1">#(...)</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># `nix develop --impure`</span>
</span></span><span class="line"><span class="cl">  <span class="n">default</span> <span class="err">=</span> <span class="n">devenv</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">mkShell</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">inherit</span> <span class="n">inputs</span> <span class="n">pkgs</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">modules</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span> <span class="n">pkgs</span><span class="o">,</span> <span class="n">lib</span><span class="o">,</span> <span class="o">...</span> <span class="p">}:</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">packages</span> <span class="o">=</span> <span class="k">with</span> <span class="n">pkgs</span><span class="p">;</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">bash</span>
</span></span><span class="line"><span class="cl">            <span class="n">just</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="c1"># for dotnet</span>
</span></span><span class="line"><span class="cl">            <span class="n">netcoredbg</span>
</span></span><span class="line"><span class="cl">            <span class="n">fsautocomplete</span>
</span></span><span class="line"><span class="cl">            <span class="n">fantomas</span>
</span></span><span class="line"><span class="cl">          <span class="p">];</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="n">languages</span><span class="o">.</span><span class="n">dotnet</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="n">package</span> <span class="o">=</span> <span class="n">dotnet</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="c1"># looks for the .env by default additionaly, there is .filename</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># if an arbitrary file is desired</span>
</span></span><span class="line"><span class="cl">          <span class="n">dotenv</span><span class="o">.</span><span class="n">enable</span> <span class="o">=</span> <span class="no">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># (...)</span>
</span></span></code></pre></div><p>and similary to the previous post, we can access the environment by doing:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  nix develop --impure
</span></span></code></pre></div><p>or, if you have <a href="https://github.com/direnv/direnv">direnv</a>, run <code>direnv allow</code>. Now you can build the project with the
usual .Net tooling:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  dotnet build
</span></span><span class="line"><span class="cl">  <span class="c1"># There is also a justfile configured to you can just</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># type &#34;just&#34; and get all commands</span>
</span></span></code></pre></div><p>Here&rsquo;s a quick demo:</p>
<p><a id="figure--fig:demo"></a></p>
<figure><img src="/img/you_have_10_seconds_to_nixify_your_dotnet_project/01_demo.gif">
</figure>

<h3 id="build-your-project-with-nix">Build your project with Nix</h3>
<p>This project is just a simple solution with the basic <a href="https://learn.microsoft.com/en-us/dotnet/fsharp/get-started/get-started-command-line">CLI Console App</a> from the
official documentation, the difference being that I&rsquo;ve added a dependency to
<a href="https://github.com/demystifyfp/FsToolkit.ErrorHandling">FsToolkit.ErrorHandling</a>, just as a way to showcase how to handle nuget
dependencies later. To package your .Net App there is already the <a href="https://github.com/NixOS/nixpkgs/blob/master/doc/languages-frameworks/dotnet.section.md#packaging-a-dotnet-application-packaging-a-dotnet-application">buildDotNetModule</a>,
you can explore all the other options later in the docs, this is what works for
the current code:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl">  <span class="c1"># `nix build`</span>
</span></span><span class="line"><span class="cl">  <span class="n">default</span> <span class="err">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">buildDotnetModule</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">pname</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">version</span> <span class="o">=</span> <span class="n">version</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">src</span> <span class="o">=</span> <span class="sr">./.</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">projectFile</span> <span class="o">=</span> <span class="s2">&#34;src/App/App.fsproj&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">nugetDeps</span> <span class="o">=</span> <span class="sr">./deps.nix</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">dotnet-sdk</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="k">with</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">dotnetCorePackages</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">combinePackages</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">sdk_8_0</span>
</span></span><span class="line"><span class="cl">      <span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">dotnet-runtime</span> <span class="o">=</span> <span class="n">pkgs</span><span class="o">.</span><span class="n">dotnetCorePackages</span><span class="o">.</span><span class="n">sdk_8_0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">};</span>
</span></span></code></pre></div><p>To properly build this with nix, you may have noticed that we also import a
<code>deps.nix</code> file in the previous step. This file contains all the nuget
dependencies our project uses and their hashes:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-nix" data-lang="nix"><span class="line"><span class="cl">  <span class="p">{</span> <span class="n">fetchNuGet</span> <span class="p">}:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">(</span><span class="n">fetchNuGet</span> <span class="p">{</span> <span class="n">pname</span> <span class="o">=</span> <span class="s2">&#34;FsToolkit.ErrorHandling&#34;</span><span class="p">;</span> <span class="n">version</span> <span class="o">=</span> <span class="s2">&#34;4.16.0&#34;</span><span class="p">;</span> <span class="n">hash</span> <span class="o">=</span> <span class="s2">&#34;sha256-4pRixOtRDgLt4/z71o1XnkuXRa/43LUhl/pDRpofX7s=&#34;</span><span class="p">;</span> <span class="p">})</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span></code></pre></div><p>You don&rsquo;t have to manually create or edit this, as its already documented
<a href="https://github.com/NixOS/nixpkgs/blob/master/doc/languages-frameworks/dotnet.section.md#generating-and-updating-nuget-dependencies-generating-and-updating-nuget-dependencies">here</a>. In this project this is already handled by the <code>just gen-deps</code> (or <code>just gd</code>)
command:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  $ rm deps.nix
</span></span><span class="line"><span class="cl">  $ just gd
</span></span><span class="line"><span class="cl">  dotnet restore --packages out
</span></span><span class="line"><span class="cl">    Determining projects to restore...
</span></span><span class="line"><span class="cl">    All projects are up-to-date <span class="k">for</span> restore.
</span></span><span class="line"><span class="cl">  nix run nixpkgs#nuget-to-nix -- out &gt; deps.nix
</span></span><span class="line"><span class="cl">  $ cat deps.nix
</span></span><span class="line"><span class="cl">  <span class="o">{</span> fetchNuGet <span class="o">}</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">    <span class="o">(</span>fetchNuGet <span class="o">{</span> <span class="nv">pname</span> <span class="o">=</span> <span class="s2">&#34;FsToolkit.ErrorHandling&#34;</span><span class="p">;</span> <span class="nv">version</span> <span class="o">=</span> <span class="s2">&#34;4.16.0&#34;</span><span class="p">;</span> <span class="nb">hash</span> <span class="o">=</span> <span class="s2">&#34;sha256-4pRixOtRDgLt4/z71o1XnkuXRa/43LUhl/pDRpofX7s=&#34;</span><span class="p">;</span> <span class="o">})</span>
</span></span><span class="line"><span class="cl">  <span class="o">]</span>
</span></span></code></pre></div><p>The previous step is also the usual way to update a .Net package in nixpkgs, most
times you&rsquo;ll just need to get the new version hash and update the nuget hashes
as well:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  $ <span class="nb">cd</span> &lt;my-clone-of-nixpkgs&gt;
</span></span><span class="line"><span class="cl">  $ nix-build -A &lt;package-name&gt;.passthru.fetch-deps <span class="p">|</span> bash
</span></span><span class="line"><span class="cl">  $ nix-build -A &lt;package-name&gt;
</span></span></code></pre></div><p>Then you open a PR to the <a href="https://github.com/NixOS/nixpkgs">official repository</a>, following the <a href="https://github.com/NixOS/nixpkgs/blob/master/CONTRIBUTING.md">contribution
guidelines</a>, of course. Now, going back to the testing the Nix build:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  $ nix build
</span></span><span class="line"><span class="cl">  $ ./result/bin/App
</span></span><span class="line"><span class="cl">  Test
</span></span><span class="line"><span class="cl">  <span class="c1"># It works</span>
</span></span></code></pre></div><h3 id="generating-oci-images">Generating OCI Images</h3>
<p>Similar to the <a href="https://mtrsk.github.io/blog/2024/experiments-with-erlang-and-nix/">previous post</a>, the Container Image looks like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  <span class="c1"># nix build .#dockerImage</span>
</span></span><span class="line"><span class="cl">  <span class="nv">dockerImage</span> <span class="o">=</span> pkgs.dockerTools.buildLayeredImage <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="nv">name</span> <span class="o">=</span> <span class="s2">&#34;sample&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">tag</span> <span class="o">=</span> <span class="s2">&#34;latest&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">created</span> <span class="o">=</span> <span class="s2">&#34;now&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">contents</span> <span class="o">=</span> <span class="o">[</span> default <span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nv">config</span> <span class="o">=</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="nv">Cmd</span> <span class="o">=</span> <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;</span><span class="si">${</span><span class="nv">default</span><span class="si">}</span><span class="s2">/bin/App&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">]</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span><span class="p">;</span>
</span></span></code></pre></div><p>And can be tested with:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">  $ nix build .#dockerImage
</span></span><span class="line"><span class="cl">  $ docker load &lt; ./result
</span></span><span class="line"><span class="cl">  $ docker container run --rm sample:latest
</span></span><span class="line"><span class="cl">  Test
</span></span></code></pre></div><h2 id="conclusion">Conclusion</h2>
<p>If this sparkled your interest somehow, here&rsquo;s the <a href="https://github.com/mtrsk/fsharp-nix/tree/master">source code</a>, I&rsquo;ve also made
sure to configure some <a href="https://github.com/mtrsk/fsharp-nix/actions">Github Actions</a> Workflows there.</p>
<h3 id="todo">TODO</h3>
<ul>
<li><input disabled="" type="checkbox"> Optimize the container image, by just shipping the runtime, not the SDK.</li>
<li><input disabled="" type="checkbox"> Open a PR into the <a href="https://github.com/NixOS/templates/tree/master/dotnet">NixOS Templates</a> repo, maybe adding a <a href="https://safe-stack.github.io/">SAFE</a> stack example
as well and a container build into the Hello Example.</li>
</ul>



   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   





<footer>
  </br>
  <p>
  Built with <a href="https://orgmode.org/">Orgmode</a>, <a href="https://www.gnu.org/software/emacs/">Emacs</a> and <a href="https://nixos.org/">Nix</a>, source code availiable <a href="https://github.com/mtrsk/mtrsk.github.io">here</a>.
  </p>
</footer>

      </main>
    </main>
  </body>
</html>
