<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
  Kubernetes

    </title>
    <meta property="og:url" content="https://mtrsk.github.io/notes/2021/kubernetes/">
  <meta property="og:site_name" content="Benevides&#39; Blog">
  <meta property="og:title" content="Kubernetes">
  <meta property="og:description" content=":ID: dd924a84-7d6f-41ec-98c2-aa16582c0d89
Kubernetes, also known as K8s, is an open-source system for automating deployment, scaling, and management of containerized applications. —kubernetes.io
Architecture Masters Also know as control plane.
A Kubernetes master is a collection of system services that make up the control plane of the cluster. The simplest setups run all the master services on a single host. However, this is only suitable for labs and test environments. For production environments, multi-master high availability (HA) is a must have.">
  <meta property="og:locale" content="en_us">
  <meta property="og:type" content="article">
    <meta property="article:section" content="notes">
    <meta property="article:published_time" content="2021-10-12T00:00:00+00:00">
    <meta property="article:modified_time" content="2021-10-12T00:00:00+00:00">
<link rel="stylesheet" href="/css/main.min.1135c79bd24c232c465ba2c4e5a9644086ce3f8358dbd0e0d76c5e86d24f1fad.css" />
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  </head>
  <body><nav>
  <img
    src="/img/logo.png"
    alt="put your logo here"
    width="128"
    height="128"
  />
  <div>
    <h1>Benevides&#39; Blog</h1><p>&#34;Writing is nothing more than a guided dream.&#34;</p>
  </div>
  <ul>
    <li><a href="/">Home</a></li>
    <li><a href="/blog">Blog</a></li>
    <li><a href="/notes">Notes</a></li>
    <li><a href="/blogroll">BlogRoll</a></li>
  </ul>
</nav>
<main>
  <h2>Kubernetes
    <small>
      <time>October 12, 2021</time>
    by Marcos Benevides


    </small>
  </h2><p>:ID:       dd924a84-7d6f-41ec-98c2-aa16582c0d89</p>
<blockquote>
<p>Kubernetes, also known as K8s, is an open-source system for automating
deployment, scaling, and management of containerized
applications. &mdash;kubernetes.io</p>
</blockquote>
<h2 id="architecture">Architecture</h2>
<h3 id="masters">Masters</h3>
<p>Also know as control plane.</p>
<blockquote>
<p>A Kubernetes master is a collection of system services that make up the control
plane of the cluster. The simplest setups run all the master services on a
single host. However, this is only suitable for labs and test environments. For
production environments, multi-master high availability (HA) is a must have.</p>
</blockquote>
<ul>
<li>Sweet spot is between 3 or 5 masters, increasing this further would make
reaching consensus impossible.</li>
<li>Don&rsquo;t run user applications on masters. This allows masters to concentrate
only on managing the cluster.</li>
</ul>
<h4 id="components">Components</h4>
<!--list-separator-->
<ul>
<li>
<p>kube-apiserver</p>
<ul>
<li>Front-end to the control plane, even the other components of the master node
have to pass through the API server.</li>
<li>Exposes a REST API that consumes JSON and YAML.</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>etcd</p>
<ul>
<li>The cluster&rsquo;s store.</li>
<li>Persists the cluster state and configuration.</li>
<li>Based on <a href="https://etcd.io/">etcd</a>.</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>controller-manager</p>
<ul>
<li>Behaves like a controller of controllers:
<ul>
<li>Node controler.</li>
<li>Deployment controller.</li>
<li>Endpoint/EndpointSlicer controller.</li>
</ul>
</li>
<li>Implements watch loops in the subcontrolers, to check if their observed state
is matching the desired state.</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>scheduler</p>
<ul>
<li>Default scheduler for kubernetes, watches the <code>kuber-apiserver</code> for new work tasks.</li>
<li>Assigns work to cluster nodes:
<ul>
<li>Affinity/Anti-Affinity.</li>
<li>Constraints.</li>
<li>Traits.</li>
<li>Resources.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="nodes">Nodes</h3>
<h4 id="components">Components</h4>
<!--list-separator-->
<ul>
<li>
<p>kubelet</p>
<ul>
<li>Main <code>kubernetes</code> agent, it runs in every node in the cluster</li>
<li>Registers node with cluster</li>
<li>Watches the API Server for work tasks and reports back to masters</li>
<li>Executes <code>pods</code></li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>Container Runtime</p>
<ul>
<li>Performs container-related tasks, like:
<ul>
<li>Pulling images</li>
<li>Start/Stop containers</li>
</ul>
</li>
<li>Can be one of the following pluggable Container Runtime Interface (CRI):
<ul>
<li>Docker</li>
<li>containerd</li>
<li>CRI-O</li>
<li>Kata</li>
</ul>
</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>kube-proxy</p>
<ul>
<li>Networking component, ensures every pod gets it&rsquo;s own unique IP</li>
<li>Basic loag-balacing</li>
</ul>
</li>
</ul>
<h3 id="packaging-apps-for-kubernetes">Packaging Apps for Kubernetes</h3>
<p>For an application to run on a Kubernetes cluster it needs to tick a few
boxes. These include:</p>
<ol>
<li>Packaged as a <code>container</code></li>
<li>Wrapped in a <code>Pod</code></li>
<li>Deployed via a declarative <code>manifest</code> file</li>
</ol>
<h4 id="pods">Pods</h4>
<blockquote>
<p>At the highest-level, a Pod is a ring-fenced environment to run containers. The
Pod itself doesn’t actually run anything, it’s just a sandbox for hosting
containers. Keeping it high level, you ring-fence an area of the host OS, build
a network stack, create a bunch of kernel namespaces, and run one or more
containers in it. That’s a Pod.</p>
</blockquote>
<ul>
<li>Kubernetes atomic unit of deployment</li>
<li>A wrapper around containers, that add the following properties which a
cluster&rsquo;s life easier:
<ul>
<li>Annotations</li>
<li>Labels</li>
<li>Policies</li>
<li>Resources</li>
<li>Co-scheduling</li>
<li>&hellip;</li>
</ul>
</li>
<li>Each <code>pod</code> has it&rsquo;s own IP</li>
</ul>
<h4 id="deployment">Deployment</h4>
<ul>
<li>A <code>deployment</code> is a higher-level Kubernetes object that wraps around a
particular Pod and adds features such as scaling, zero-downtime updates, and
versioned rollbacks.</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>ReplicaSet</p>
<p>A ReplicaSet&rsquo;s purpose is to maintain a stable set of replica Pods running at
any given time. As such, it is often used to guarantee the availability of a
specified number of identical Pod, by implementing the following:</p>
<ul>
<li>Self-healing mechanisms</li>
<li>Ensure the requested number of pods is running at any given time</li>
<li>Provide fault-tolerance</li>
<li>Can be used to scale Pods</li>
</ul>
</li>
</ul>
<!--list-separator-->
<ul>
<li>
<p>YAML Structure</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">apps/v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Deployment</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web-deploy</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">minReadySeconds</span><span class="p">:</span><span class="w"> </span><span class="m">5</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">strategy</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">RollingUpdate</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">rollingUpdate</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxUnavailable</span><span class="p">:</span><span class="w"> </span><span class="m">0</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">maxSurge</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">terminationGracePeriodSeconds</span><span class="p">:</span><span class="w"> </span><span class="m">1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;container-name&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;registry-image&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">imagePullPolicy</span><span class="p">:</span><span class="w"> </span><span class="l">Always</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span></code></pre></div></li>
</ul>
<h3 id="service">Service</h3>
<ul>
<li>An abstract way to expose an application running on a set of Pods as a network
service</li>
<li>Implements a front-end that consists of:
<ul>
<li>A stable DNS name</li>
<li>Permanent IP address and port, not connected to the <code>pod</code> lifecycle</li>
</ul>
</li>
<li>The backend layer has the following tasks:
<ul>
<li>Load-balancing across different pods</li>
<li>Only sends traffic to a healthy pod</li>
</ul>
</li>
<li>Can do session affinity</li>
<li>Can send traffic to endpoits outside the cluster</li>
<li>Can do TCP and UDP</li>
<li>Handles both external access (via the internet) or internally through the
cluster</li>
</ul>
<blockquote>
<p>Services use labels and a label selector to know which set of Pods to
load-balance traffic to. The Service has a label selector that is a list of all
the labels a Pod must possess in order for it to receive traffic from the
Service.</p>
</blockquote>
<!--list-separator-->
<ul>
<li>
<p>Types</p>
<ul>
<li><code>Loadbalancer</code>: External access via cloud load-balancer</li>
<li><code>NotePort</code>: External access via nodes</li>
</ul>
 <!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-nodeport</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">NodePort</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span>- <span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="m">80</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">nodePort</span><span class="p">:</span><span class="w"> </span><span class="m">31111</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l">TCP</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">selector</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span></code></pre></div><ul>
<li><code>ClusterIP</code> (default): Internal cluster connectivity</li>
<li><code>ExternalName</code></li>
</ul>
 <!--listend-->
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w">  </span><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Service</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-en</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l">ExternalName</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">externalName</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;service-name&gt;.&lt;namespace&gt;.svc.cluster.local</span><span class="w">
</span></span></span></code></pre></div></li>
</ul>
<h3 id="pods">Pods</h3>
<!--list-separator-->
<ul>
<li>
<p>YAML structure</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l">v1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l">Pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">metadata</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">example-pod</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">labels</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l">web</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">spec</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">containers</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span>- <span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l">web-ctr</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l">&lt;image-from-registry&gt;</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">      </span><span class="nt">ports</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span>- <span class="nt">containerPort</span><span class="p">:</span><span class="w"> </span><span class="m">8080</span><span class="w">
</span></span></span></code></pre></div></li>
</ul>



   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   

   

   

   

   
      
   

   

   

   

   

   

   




  <hr>
  <div class="bl-section">
    <h4>Links to this note</h4>
    <div class="backlinks">
      <ul>
       
          <li><a href="/blog/2023/how-to-use-private-neovim-plugins-on-nixos/">How To Use Private Neovim Plugins On Nixos</a></li>
       
          <li><a href="/notes/2021/kubernetes-storage/">Kubernetes Storage</a></li>
       
     </ul>
    </div>
  </div>


<footer>
  </br>
  <p>
  Built with <a href="https://orgmode.org/">Orgmode</a>, <a href="https://www.gnu.org/software/emacs/">Emacs</a> and <a href="https://nixos.org/">Nix</a>, source code availiable <a href="https://github.com/mtrsk/mtrsk.github.io">here</a>.
  </p>
</footer>

      </main>
    </main>
  </body>
</html>
